name: Refresh Jobs (Every 12h)

on:
  schedule:
    - cron: "0 */12 * * *" # –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
  workflow_dispatch: # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # üîπ –Ω—É–∂–µ–Ω –ø—É—Å—Ç–æ–π .env –≤ –∫–æ—Ä–Ω–µ, —á—Ç–æ–±—ã tsx —Å --env-file=../../.env –Ω–µ —Ä—É–≥–∞–ª—Å—è
      - name: Create empty .env for tsx
        run: touch .env

      - name: Install dependencies
        run: npm ci

      - name: Install Turbo cache (optional, faster)
        run: npm install turbo --global

      # üîπ –ù–û–í–´–ô –®–ê–ì ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client –¥–ª—è –≤—Å–µ—Ö, –∫—Ç–æ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç (API, workers)
      - name: Generate Prisma Client
        run: npm run -w @junior-ua/api prisma:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run Jooble Worker
        run: npm run -w @junior-ua/workers jobs:run:jooble
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JOOBLE_API_KEY: ${{ secrets.JOOBLE_API_KEY }}
          JOOBLE_API_ENDPOINT: ${{ secrets.JOOBLE_API_ENDPOINT }}
          JOOBLE_LOCATION_DEFAULT: ${{ secrets.JOOBLE_LOCATION_DEFAULT }}
          JOOBLE_QUERY: ${{ secrets.JOOBLE_QUERY }}
          JOOBLE_PAGE_SIZE: ${{ secrets.JOOBLE_PAGE_SIZE }}
          JOOBLE_MAX_PAGES: ${{ secrets.JOOBLE_MAX_PAGES }}

      - name: Run Remotive Worker
        run: npm run -w @junior-ua/workers jobs:run:remotive
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REMOTIVE_API_ENDPOINT: ${{ secrets.REMOTIVE_API_ENDPOINT }}
          REMOTIVE_CATEGORY: ${{ secrets.REMOTIVE_CATEGORY }}
          REMOTIVE_SEARCH: ${{ secrets.REMOTIVE_SEARCH }}
          REMOTIVE_LIMIT: ${{ secrets.REMOTIVE_LIMIT }}

      - name: Run Adzuna Worker
        run: npm run -w @junior-ua/workers jobs:run:adzuna
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          ADZUNA_COUNTRY: ${{ secrets.ADZUNA_COUNTRY }}
          ADZUNA_CATEGORY: ${{ secrets.ADZUNA_CATEGORY }}
          ADZUNA_WHAT: ${{ secrets.ADZUNA_WHAT }}
          ADZUNA_PAGE_SIZE: ${{ secrets.ADZUNA_PAGE_SIZE }}
          ADZUNA_MAX_PAGES: ${{ secrets.ADZUNA_MAX_PAGES }}

      - name: Reindex Search (DB mode)
        run: npm run -w @junior-ua/api search:reindex
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          API_SEARCH_ENABLED: "false"   # –ª—É—á—à–µ —Å—Ç—Ä–æ–∫–æ–π
          API_ADMIN_TOKEN: ${{ secrets.API_ADMIN_TOKEN }}



