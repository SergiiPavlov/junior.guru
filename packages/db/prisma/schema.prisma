// Prisma schema for Junior UA platform
// Datasource configuration for PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Source {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  type        String?
  description String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  jobs        Job[]
  events      Event[]
  crawls      Crawl[]

  @@map("sources")
}

model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  websiteUrl String? @map("website_url")
  email       String?
  location    String?
  description String?
  logoUrl String? @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  jobs        Job[]

  @@map("companies")
}

model Region {
  id        String  @id @default(cuid())
  code      String  @unique
  nameUk String @map("name_uk")
  nameEn String @map("name_en")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  jobs      Job[]
  events    Event[]

  @@map("regions")
}

model Tag {
  id        String        @id @default(cuid())
  slug      String        @unique
  nameUk String @map("name_uk")
  nameEn String? @map("name_en")
  category  String?
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  jobTags JobTag[] 
  eventTags EventTag[] 

  @@map("tags")
}

model Job {
  id             String      @id @default(cuid())
  sourceId String @map("source_id")
  companyId String? @map("company_id")
  regionId String? @map("region_id")
  title          String
  slug           String      @unique
  city           String?
  remote         Boolean     @default(false)
  urlOriginal String? @map("url_original")
  urlApply String? @map("url_apply")
  salaryMin Int? @map("salary_min")
  salaryMax Int? @map("salary_max")
  currency       String?     @db.VarChar(8)
  experience     String?
  employmentType String? @map("employment_type")
  skills         String[]    @default([])
  tags           String[]    @default([])
  descriptionRaw String? @map("description_raw")
  description    String?
  publishedAt DateTime    @default(now()) @map("published_at")
  validUntil DateTime? @map("valid_until")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  source         Source      @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  company        Company?    @relation(fields: [companyId], references: [id], onDelete: SetNull)
  region         Region?     @relation(fields: [regionId], references: [id], onDelete: SetNull)
  jobTags JobTag[] 

  @@index([sourceId])
  @@index([companyId])
  @@index([regionId])
  @@index([remote])
  @@index([publishedAt])
  @@index([skills], type: Gin)
  @@index([tags], type: Gin)
  @@map("jobs")
}

model Event {
  id             String      @id @default(cuid())
  sourceId String @map("source_id")
  regionId String? @map("region_id")
  title          String
  slug           String      @unique
  urlOriginal String? @map("url_original")
  urlRegister String? @map("url_register")
  venue          String?
  city           String?
  remote         Boolean     @default(false)
  skills         String[]    @default([])
  tags           String[]    @default([])
  descriptionRaw String? @map("description_raw")
  description    String?
  startAt DateTime @map("start_at")
  endAt DateTime? @map("end_at")
  language       String?     @db.VarChar(8)
  priceFrom Int? @map("price_from")
  priceTo Int? @map("price_to")
  currency       String?     @db.VarChar(8)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  source         Source      @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  region         Region?     @relation(fields: [regionId], references: [id], onDelete: SetNull)
  eventTags EventTag[] 

  @@index([sourceId])
  @@index([regionId])
  @@index([remote])
  @@index([startAt])
  @@index([skills], type: Gin)
  @@index([tags], type: Gin)
  @@map("events")
}

model Crawl {
  id         String   @id @default(cuid())
  sourceId String @map("source_id")
  startedAt DateTime @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  status     String   @default("pending")
  itemsFound Int      @default(0) @map("items_found")
  error      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  source     Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@map("crawls")
}

model JobTag {
  jobId String @map("job_id")
  tagId String @map("tag_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([jobId, tagId])
  @@index([tagId])
  @@map("job_tags")
}

model EventTag {
  eventId String @map("event_id")
  tagId String @map("tag_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  event  Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag    Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([eventId, tagId])
  @@index([tagId])
  @@map("event_tags")
}
